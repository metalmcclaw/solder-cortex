services:
  cortex:
    build: .
    ports:
      - "3000:3000"
    environment:
      - CORTEX__SERVER__HOST=0.0.0.0
      - CORTEX__SERVER__PORT=3000
      - CORTEX__DATABASE__URL=http://clickhouse:8123
      - CORTEX__DATABASE__DATABASE=cortex
      - CORTEX__DATABASE__USER=default
      - CORTEX__DATABASE__PASSWORD=clickhouse
      - CORTEX__LYSLABS__API_KEY=${CORTEX__LYSLABS__API_KEY}
      - CORTEX__LYSLABS__WS_URL=wss://solana-mainnet-api-vip.lyslabs.ai/v1/
      - CORTEX__HELIUS__API_KEY=${CORTEX__HELIUS__API_KEY}
      - RUST_LOG=cortex=debug,tower_http=debug
      - RUST_BACKTRACE=1
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    tty: true

  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./migrations:/docker-entrypoint-initdb.d
    environment:
      - CLICKHOUSE_DB=cortex
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=clickhouse
    healthcheck:
      test: ["CMD", "clickhouse-client", "--user", "default", "--password", "clickhouse", "--query", "SELECT 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    restart: unless-stopped

  swagger-ui:
    image: swaggerapi/swagger-ui
    ports:
      - "8080:8080"
    volumes:
      - ./openapi.yaml:/spec/openapi.yaml
    environment:
      - SWAGGER_JSON=/spec/openapi.yaml
    restart: unless-stopped

  clickhouse-ui:
    image: spoonest/clickhouse-tabix-web-client
    ports:
      - "8081:80"
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: unless-stopped

  # Prediction Market MCP Server
  # Note: MCP servers typically run locally via stdio, not as Docker services
  # This is provided for containerized deployments that need HTTP wrapping
  cortex-prediction-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["/app/cortex-prediction-mcp"]
    environment:
      - CORTEX_PREDICTION__DATABASE__URL=http://clickhouse:8123
      - CORTEX_PREDICTION__DATABASE__DATABASE=cortex
      - CORTEX_PREDICTION__DATABASE__USER=default
      - CORTEX_PREDICTION__DATABASE__PASSWORD=clickhouse
      - CORTEX_PREDICTION__CACHE__MAX_CAPACITY=1000
      - CORTEX_PREDICTION__CACHE__TTL_SECONDS=60
      - RUST_LOG=cortex_prediction_mcp=info
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: unless-stopped
    # stdin_open and tty for MCP stdio communication
    stdin_open: true
    tty: true

volumes:
  clickhouse_data:
